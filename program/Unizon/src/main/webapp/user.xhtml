<?xml version="1.0" encoding="UTF-8"?>
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:p="http://primefaces.org/ui"
	template="/WEB-INF/templates/default_user.xhtml">

	<ui:define name="custom_css">
		<h:outputStylesheet name="css/user.css" />
	</ui:define>

	<ui:define name="custom_js"></ui:define>

	<ui:define name="fullBody">
		<p:dialog header="Add Address" resizable="false" draggable="false"
			styleClass="address_modal" id="addAddressDialog" closeOnEscape="true"
			modal="true" widgetVar="addAddressDialogVar">
			<!-- Add address form -->
			<div class="login_form_container">
				<h:form id="addAddressDialogForm" class="login_form">
					<p:outputLabel for="zip" value="ZIP code:" styleClass="required" />
					<p:inputText id="zip" value="#{addressController.newAddress.zip}"
						maxlength="10" required="true"
						requiredMessage="ZIP code is required!" tabindex="1">
						<f:attribute name="componentname" value="zipcode" />
					</p:inputText>

					<p:outputLabel for="country" value="Country:" styleClass="required" />
					<p:inputText id="country"
						value="#{addressController.newAddress.country}" maxlength="100"
						required="true" requiredMessage="Country is required!"
						validator="alphabeticInputValidator" tabindex="2">
						<f:attribute name="componentname" value="country" />
					</p:inputText>

					<p:outputLabel for="city" value="City:" styleClass="required" />
					<p:inputText id="city" value="#{addressController.newAddress.city}"
						maxlength="100" required="true"
						requiredMessage="City is required!"
						validator="alphabeticInputValidator" tabindex="3">
						<f:attribute name="componentname" value="city" />
					</p:inputText>

					<p:outputLabel for="street" value="Street:" styleClass="required" />
					<p:inputText id="street"
						value="#{addressController.newAddress.street}" maxlength="100"
						required="true" requiredMessage="Street is required!" tabindex="4">
						<f:attribute name="componentname" value="streetname" />
					</p:inputText>

					<p:outputLabel for="street_num" value="Street number:"
						styleClass="required" />
					<p:inputText id="street_num"
						value="#{addressController.newAddress.strNumber}" required="true"
						requiredMessage="Street number is required!" styleClass="required"
						tabindex="5" converterMessage="Please enter digits only.">
						<f:attribute name="componentname" value="streetnumber" />
					</p:inputText>

					<p:outputLabel value="Floor:" />
					<p:inputText value="#{addressController.newAddress.floor}"
						tabindex="6" converterMessage="Please enter digits only.">
						<f:attribute name="componentname" value="floor" />
					</p:inputText>

					<p:outputLabel value="Door:" />
					<p:inputText value="#{addressController.newAddress.door}"
						tabindex="7" converterMessage="Please enter digits only.">
						<f:attribute name="componentname" value="door" />
					</p:inputText>

					<h:outputText styleClass="req_fields_label"
						value="All fields marked with an asterisk are required." />

					<p:commandButton value="Add" styleClass="custom_button"
						actionListener="#{addressController.addAddress()}" ajax="true"
						update=":messages, :addAddressDialogForm" tabindex="8" />
					<p:commandButton value="Cancel" styleClass="custom_button"
						actionListener="#{loginController.showUserProfile()}" ajax="true"
						immediate="true" tabindex="9" />
				</h:form>
			</div>
		</p:dialog>

		<p:dialog header="Edit Address" resizable="false" draggable="false"
			styleClass="address_modal" id="editAddressDialog"
			closeOnEscape="true" modal="true" widgetVar="editAddressDialogVar">
			<!-- Edit address form -->
			<div class="login_form_container">
				<h:form id="editAddressDialogForm" class="login_form">
					<p:outputLabel for="zipcode" value="ZIP code:"
						styleClass="required" />
					<p:inputText id="zipcode"
						value="#{addressController.newAddress.zip}" maxlength="10"
						required="true" requiredMessage="ZIP code is required!"
						tabindex="1">
						<f:attribute name="componentname" value="zipcode" />
					</p:inputText>

					<p:outputLabel for="count" value="Country:" styleClass="required" />
					<p:inputText id="count"
						value="#{addressController.newAddress.country}" maxlength="100"
						required="true" requiredMessage="Country is required!"
						validator="alphabeticInputValidator" tabindex="2">
						<f:attribute name="componentname" value="country" />
					</p:inputText>

					<p:outputLabel for="cit" value="City:" styleClass="required" />
					<p:inputText id="cit" value="#{addressController.newAddress.city}"
						maxlength="100" required="true"
						requiredMessage="City is required!"
						validator="alphabeticInputValidator" tabindex="3">
						<f:attribute name="componentname" value="city" />
					</p:inputText>

					<p:outputLabel for="str" value="Street:" styleClass="required" />
					<p:inputText id="str"
						value="#{addressController.newAddress.street}" maxlength="100"
						required="true" requiredMessage="Street is required!" tabindex="4">
						<f:attribute name="componentname" value="streetname" />
					</p:inputText>

					<p:outputLabel for="num" value="Street number:"
						styleClass="required" />
					<p:inputText id="num"
						value="#{addressController.newAddress.strNumber}" required="true"
						requiredMessage="Street number is required!" styleClass="required"
						tabindex="5" converterMessage="Please enter digits only.">
						<f:attribute name="componentname" value="streetnumber" />
					</p:inputText>

					<p:outputLabel value="Floor:" />
					<p:inputText value="#{addressController.newAddress.floor}"
						tabindex="6" converterMessage="Please enter digits only.">
						<f:attribute name="componentname" value="floor" />
					</p:inputText>

					<p:outputLabel value="Door:" />
					<p:inputText value="#{addressController.newAddress.door}"
						tabindex="7" converterMessage="Please enter digits only.">
						<f:attribute name="componentname" value="door" />
					</p:inputText>

					<h:outputText styleClass="req_fields_label"
						value="All fields marked with an asterisk are required." />

					<p:commandButton value="Edit" styleClass="custom_button"
						actionListener="#{addressController.editAddress()}" ajax="true"
						update=":messages, :editAddressDialogForm" tabindex="8" />
					<p:commandButton value="Cancel" styleClass="custom_button"
						actionListener="#{loginController.showUserProfile()}" ajax="true"
						immediate="true" tabindex="9" />
				</h:form>
			</div>
		</p:dialog>

		<p:dialog header="Add Phone Number" resizable="false"
			draggable="false" styleClass="phone_modal" id="addPhoneNumberDialog"
			closeOnEscape="true" modal="true" widgetVar="addPhoneNumberDialogVar">
			<!-- Add phone number form -->
			<div class="login_form_container">
				<h:form id="addPhoneNumberDialogForm" class="login_form">
					<p:outputLabel value="Phone number:" styleClass="required" />
					<p:inputText value="#{phoneNumberController.newPhoneNumber}"
						tabindex="1" required="true"
						requiredMessage="Phone number is required!" maxlength="12"
						validator="phoneNumberValidator">
					</p:inputText>

					<p:commandButton value="Add" styleClass="custom_button"
						actionListener="#{phoneNumberController.addPhoneNumber()}"
						ajax="true" update=":messages, :addPhoneNumberDialogForm" />
					<p:commandButton value="Cancel" styleClass="custom_button"
						actionListener="#{loginController.showUserProfile()}" ajax="true"
						immediate="true" tabindex="2" />
				</h:form>
			</div>
		</p:dialog>

		<p:dialog header="Edit Phone Number" resizable="false"
			draggable="false" styleClass="phone_modal" id="editPhoneNumberDialog"
			closeOnEscape="true" modal="true"
			widgetVar="editPhoneNumberDialogVar">
			<!-- Edit phone number form -->
			<div class="login_form_container">
				<h:form id="editPhoneNumberDialogForm" class="login_form">
					<p:outputLabel value="Phone number:" styleClass="required" />
					<p:inputText value="#{phoneNumberController.newPhoneNumber}"
						tabindex="1" required="true"
						requiredMessage="Phone number is required!" maxlength="12"
						validator="phoneNumberValidator">
					</p:inputText>

					<p:commandButton value="Edit" styleClass="custom_button"
						actionListener="#{phoneNumberController.editPhoneNumber()}"
						ajax="true" update=":messages, :editPhoneNumberDialogForm" />
					<p:commandButton value="Cancel" styleClass="custom_button"
						actionListener="#{loginController.showUserProfile()}" ajax="true"
						immediate="true" tabindex="2" />
				</h:form>
			</div>
		</p:dialog>

		<div id="modal_change_pw" class="popupContainer"
			style="display: none;">
			<div class="popupHeader">
				<span class="header_title">Change Password</span> <span
					id="close_modal_change_pw" class="modal_close"><i
					class="fa fa-times"></i></span>
			</div>

			<div class="popupBody">

				<!-- Change password form -->
				<div class="login_form_container">
					<h:form id="changePasswordForm">
						<p:outputLabel value="Current password:" styleClass="required" />
						<p:password value="#{userController.currentPassword}"
							required="true" requiredMessage="Password is required!"
							tabindex="1" />

						<p:outputLabel value="New password:" styleClass="required" />
						<p:password value="#{userController.newPassword}" required="true"
							requiredMessage="Password is required!" match="passwordAgain"
							validatorMessage="The passwords did not match!" tabindex="2" />

						<p:outputLabel value="Confirm password:" styleClass="required" />
						<p:password id="passwordAgain" tabindex="3" />

						<p:commandButton value="Change" styleClass="custom_button"
							actionListener="#{userController.changePassword()}" ajax="true"
							update=":messages" tabindex="5" />
						<p:commandButton value="Cancel" styleClass="custom_button"
							actionListener="#{loginController.showUserProfile()}" ajax="true"
							immediate="true" tabindex="4" />
					</h:form>
				</div>
			</div>
		</div>

		<div id="tab_container" class="container">
			<p:tabView rendered="#{loginController.loggedIn}">
				<p:growl id="messages" life="4000" showDetail="true" />
				<p:tab class="tab" title="User information">
					<div class="info_panel">
						<div id="info_container">
							<div class="info_header">
								<h3>Account information:</h3>
							</div>
							<!-- Table 1 -->
							<div id="table_1" class="table">
								<!-- Row 1 -->
								<div class="table_row">
									<div class="table_element">
										<a href="#"><i class="fa fa-pencil"></i></a>
									</div>
									<div class="table_element">
										<p>Name:</p>
									</div>
									<div class="table_element">
										<p>#{loginController.user.name}</p>
									</div>
								</div>
								<!-- Row 2 -->
								<div class="table_row">
									<div class="table_element">
										<a id="change_pw_trigger" class="modal_trigger"
											rel="leanModal" href="#modal_change_pw"><i
											class="fa fa-lock"></i></a>
									</div>
									<div class="table_element">
										<p>Username:</p>
									</div>
									<div class="table_element">
										<p>#{loginController.user.username}</p>
									</div>
								</div>
								<!-- Row 3 -->
								<div class="table_row">
									<div class="table_element">
										<h:outputText value="&#160;" />
									</div>
									<div class="table_element">
										<p>E-mail address:</p>
									</div>
									<div class="table_element">
										<p>#{loginController.user.EMail}</p>
									</div>
								</div>
								<!-- Row 4 -->
								<div class="table_row">
									<div class="table_element">
										<h:outputText value="&#160;" />
									</div>
									<div class="table_element">
										<p>Registration date:</p>
									</div>
									<div class="table_element">
										<p>#{loginController.user.registrationDate}</p>
									</div>
								</div>
								<!-- Row 5 -->
								<div class="table_row">
									<div class="table_element">
										<h:outputText value="&#160;" />
									</div>
									<div class="table_element">
										<p>Status:</p>
									</div>
									<div class="table_element">
										<h:form id="userStatusForm">
											<p>#{loginController.user.userStatus.statusName}</p>
											<p:commandButton
												actionListener="#{userController.sendActivationLink()}"
												ajax="true" update=":messages"
												rendered="#{loginController.user.userStatus.statusName eq 'inactive'}"
												value="Resend activation link" />
										</h:form>
									</div>
								</div>
							</div>
						</div>

						<!-- Address table -->
						<div id="address_table">
							<div id="address_header">
								<div class="header_row">
									<div class="header_cell">
										<h:form>
											<p:remoteCommand name="addAddressRemoteCommand"
												actionListener="#{addressController.addAddressListen}"
												update="addAddressDialog"
												oncomplete="PF('addAddressDialogVar').show()" />

											<a id="new_address_trigger" rel="leanModal"
												onclick="addAddressRemoteCommand([{name:'addressId', value:0}]);">
												<i class="fa fa-plus"></i>
											</a>
										</h:form>
									</div>
									<div class="header_cell">
										<h3>Address(es):</h3>
									</div>
								</div>
							</div>
							<div id="address_content">
								<ui:repeat value="#{loginController.user.addresses.toArray()}"
									var="address">

									<div class="address_row">
										<div class="address_cell">
											<p>#{address.toString()}</p>
										</div>
										<div class="address_cell">
											<h:form>
												<p:remoteCommand name="editAddressRemoteCommand"
													actionListener="#{addressController.editAddressListen}"
													update="editAddressDialog"
													oncomplete="PF('editAddressDialogVar').show()" />

												<a id="edit_address_trigger" rel="leanModal"
													data-toggle="modal" data-id="#{address.addressId}"
													onclick="editAddressRemoteCommand([{name:'addressId', value:#{address.addressId}}]);">
													<i class="fa fa-edit"></i>
												</a>
											</h:form>
										</div>
										<div class="address_cell">
											<h:form transient="true" id="removeAddressForm">
												<p:remoteCommand name="removeAddressRemoteCommand"
													actionListener="#{addressController.removeAddress}"
													process="@this" oncomplete="location.reload();" />

												<p:commandLink id="remove"
													onclick="removeAddressRemoteCommand([{name:'addressId', value:#{address.addressId}}]);">
													<f:ajax render="@form" />
													<i class="fa fa-remove"></i>
													<p:confirm header="Confirmation" message="Are you sure?"
														icon="ui-icon-alert" />
												</p:commandLink>
												<p:confirmDialog global="true" showEffect="fade"
													hideEffect="fade">
													<p:commandButton value="Yes" type="button"
														styleClass="ui-confirmdialog-yes" icon="ui-icon-check" />
													<p:commandButton value="No" type="button"
														styleClass="ui-confirmdialog-no" icon="ui-icon-close" />
												</p:confirmDialog>
											</h:form>
										</div>
									</div>
								</ui:repeat>
							</div>
						</div>

						<!-- Phone table -->
						<div id="phone_table">
							<div id="phone_header">
								<div class="header_row">
									<div class="header_cell">
										<h:form>
											<p:remoteCommand name="addPhoneNumberRemoteCommand"
												actionListener="#{phoneNumberController.addPhoneNumberListen}"
												update="addPhoneNumberDialog"
												oncomplete="PF('addPhoneNumberDialogVar').show()" />

											<a id="new_phone_trigger" rel="leanModal"
												onclick="addPhoneNumberRemoteCommand([{name:'phoneNumberId', value:0}]);">
												<i class="fa fa-plus"></i>
											</a>
										</h:form>
									</div>
									<div class="header_cell">
										<h3>Phone number(s):</h3>
									</div>
								</div>
							</div>
							<div id="phone_content">
								<ui:repeat
									value="#{loginController.user.phoneNumbers.toArray()}" var="pn">
									<div class="address_row">
										<div class="phone_cell">
											<p>#{pn.toString()}</p>
										</div>
										<div class="phone_cell">
											<h:form>
												<p:remoteCommand name="editPhoneNumberRemoteCommand"
													actionListener="#{phoneNumberController.editPhoneNumberListen}"
													update="editPhoneNumberDialog"
													oncomplete="PF('editPhoneNumberDialogVar').show()" />

												<a id="edit_phone_number_trigger" rel="leanModal"
													data-toggle="modal"
													onclick="editPhoneNumberRemoteCommand([{name:'phoneNumberId', value:#{pn.phoneNumberId}}]);">
													<i class="fa fa-edit"></i>
												</a>
											</h:form>
										</div>
										<div class="phone_cell">
											<h:form transient="true" id="removeAddressForm">
												<p:remoteCommand name="removePhoneNumberRemoteCommand"
													actionListener="#{phoneNumberController.removePhoneNumberFromUser}"
													process="@this" oncomplete="location.reload();" />

												<p:commandLink id="remove"
													onclick="removePhoneNumberRemoteCommand([{name:'phoneNumberId', value:#{pn.phoneNumberId}}]);">
													<f:ajax render="@form" />
													<i class="fa fa-remove"></i>
													<p:confirm header="Confirmation" message="Are you sure?"
														icon="ui-icon-alert" />
												</p:commandLink>
												<p:confirmDialog global="true" showEffect="fade"
													hideEffect="fade">
													<p:commandButton value="Yes" type="button"
														styleClass="ui-confirmdialog-yes" icon="ui-icon-check" />
													<p:commandButton value="No" type="button"
														styleClass="ui-confirmdialog-no" icon="ui-icon-close" />
												</p:confirmDialog>
											</h:form>
										</div>
									</div>
								</ui:repeat>
							</div>
						</div>
					</div>
				</p:tab>
				<p:tab class="tab" title="Previous orders">
					<div id="order_container">
						<div id="datatable_container">
							<p:dataTable var="ord"
								value="#{loginController.user.orders.toArray()}"
								styleClass="borderless">
								<p:column class="po_rowtoggler">
									<p:rowToggler />
								</p:column>
								<p:column class="po_date" headerText="Date">
									<h:outputText class="po_celltext" value="#{ord.orderDate}" />
								</p:column>
								<p:column class="po_saddress" headerText="Shipping address">
									<h:outputText class="po_celltext" value="#{ord.address1}" />
								</p:column>
								<p:column class="po_baddress" headerText="Billing address">
									<h:outputText class="po_celltext" value="#{ord.address2}" />
								</p:column>
								<p:column class="po_phone" headerText="Phone number">
									<h:outputText class="po_celltext"
										value="#{ord.phoneNumber.phoneNumber}" />
								</p:column>
								<p:column class="po_total_price" headerText="Total price">
									<h:outputText class="po_celltext"
										value="#{ord.prodToOrders.stream().map(prod -> prod.product.price * prod.amount).sum()}">
										<f:convertNumber currencyCode="USD" type="currency" />
									</h:outputText>
								</p:column>
								<p:rowExpansion>
									<p:dataTable class="inner_table" var="prod"
										value="#{ord.prodToOrders.toArray()}">
										<p:column class="po_prod_empty">
											<h:outputText class="empty_cell" value=" " />
										</p:column>
										<p:column class="po_prod_imgcol">
											<p:graphicImage value="#{imageStreamer.image}" styleClass="po_prod_img">
												<f:param name="imageId" value="#{prod.product.image.imageUrl}" />
											</p:graphicImage>
										</p:column>
										<p:column class="po_prod_name" headerText="Product name">
											<h:outputText class="po_celltext"
												value="#{prod.product.title}" />
										</p:column>
										<p:column class="po_prod_amount" headerText="Amount">
											<h:outputText class="po_celltext" value="#{prod.amount}" />
										</p:column>
										<p:column class="po_prod_price" headerText="Price">
											<h:outputText class="po_celltext"
												value="$#{prod.product.price}" />
										</p:column>
									</p:dataTable>
								</p:rowExpansion>
							</p:dataTable>
						</div>
					</div>
				</p:tab>
			</p:tabView>
		</div>
	</ui:define>
</ui:composition>